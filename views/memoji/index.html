<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <title>Memoji || Emoji Arcade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- Reference to reset.min css sheet. --> 
    <link rel="stylesheet" type="text/css" href="/static/css/reset.min.css">
    <!-- add jQuery -->
      <!-- Reference to jQuery version 2.2.3. -->
    <script src="https://code.jquery.com/jquery-2.2.3.js" integrity="sha256-laXWtGydpwqJ8JA+X9x2miwmaiKhn8tVmOVEigRNtP4=" crossorigin="anonymous"
    ></script>
    <!-- Reference to materialize css sheet. -->
    <link rel="stylesheet" type="text/css" href="/static/css/materialize.css">
    <!-- Reference to Materialize.min javascript sheet. -->
    <script src="/static/js/materialize.js"></script>
    <!-- Reference to app style sheet. -->  
    <link rel="stylesheet" type="text/css" href="/static/css/emoji_arcade_style.css">
      <!-- Reference to index.js -->
    <script src="/static/js/index.js"></script>
    <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!-- Add Google Web Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700|Press+Start+2P|Rubik:300,300i,400,400i,500,500i,700,700i,900,900i|Share+Tech+Mono|Ubuntu+Condensed|VT323" rel="stylesheet">

</head>

<body>
  <div class="container home">     

    <header>
      <div class="row">
        <div class="col s12 m4 l4">
          <img src="/static/images/memoji-logo-small.png" width="200px" class="minigame-logo">
        </div>

        <div class="col s12 m4 l4"  id="welcome">
          Welcome, Player!
        </div>

        <div class="col s12 m4 l4" id="nav">
            <!--<a href="/memoji/new"><img src="../images/start.png" width="80"></a> -->
            <a class="waves-effect modal-trigger" href="#modalScores">
            <img src="static/images/scores.png" width="80" class="scores-button">
            </a> 

                      <div id="modalScores" class="modal">
                        <div class="modal-content">
                          <h4 class="modal-title">High Scores</h4>
                          <div class="row high-score-row">
                            <div class="col s4">seeksort</div>
                            <div class="col s4 score-num">865</div>
                            <div class="col s4">11/17/16</div>
                          </div>

                          <div class="row high-score-row">
                            <div class="col s4">tuantran1122</div>
                            <div class="col s4 score-num">745</div>
                            <div class="col s4">11/17/16</div>
                          </div>

                          <div class="row high-score-row">
                            <div class="col s4">brandon_s </div>
                            <div class="col s4 score-num">675</div>
                            <div class="col s4">11/17/16</div>
                          </div>

                          <div class="row high-score-row">
                            <div class="col s4">marcus-lam</div>
                            <div class="col s4 score-num">545</div>
                            <div class="col s4">11/17/16</div>
                          </div>

                          <div class="row high-score-row">
                            <div class="col s4">shabbyveneer</div>
                            <div class="col s4 score-num">2</div>
                            <div class="col s4">11/17/16</div>
                          </div>
                        </div>
                      </div>   
        </div>       
      </div>
    </header>

   <main class="memoji">
     <div class="row">
        <div class="col s12 m4 l4">
          <div id="gameTime">
          <div id="minutes" class="timer">00</div>:<div id="seconds" class="timer">00</div></div>
          <div id="gameMessage">Choose two cards that match.</div>
        </div>

        <div class="col s12 m8 l8 gameboard">
                  
        </div>
      </div>
   </main>

     <footer>
       <div class="row">
        <div class="col s6 m6 l4" >
        </div>

        <div class="col s6 m6 l4">
        </div>

         <div class="col s12 m12 l4" id="gameLogo">
          <a href="/"><img src="/static/images/ea-logo-2.png" width="150px"></a>
        </div>

    </footer> 

  </div>

<script>

$(document).ready(function(){

  
  $('.modal-trigger').leanModal();

  $('.emoji-card').on('click', flipCard)

// var easyArrayTiles = [], // 24 tiles
  // mediumArrayTiles = [], // 36 tiles.
  // hardArrayTiles = []; // 48 tiles.

// Skull Milo Card 
// Skull card = 1 if flipped. Punishes them by randomizing the board
// Skull card when both cards are displayed you lose.
// Milo card = 1 if flipped. Rewards them by flipping all cards for 1 second.
// Milo card gives a bonus.
// A and B will be the skull/milo cards. Does not required to be filed to win/lose.

runTableQuery('Animals');
difficultySelection('hard');

function runTableQuery(theme){
    // Here we get the location of the root page.
    // We use this instead of explicitly saying the URL is localhost:3001 because the url will change when we deploy.
    var currentURL = window.location.origin;

    // The AJAX function uses the URL of our API to GET the data associated with it (initially set to localhost)
    $.ajax({url: currentURL + "/data/" + theme, method: "GET"})
        .done(function(data) {
            tableData = data;
            console.log(tableData);
            for(var i = 0; i<tableData.length;i++){
                emojiObjects.push(tableData[i]);
            }
            initDeck();
        });
}

var calcWinScore = function(difficultyNumber){
  console.log(difficultyNumber / 2);
    return (difficultyNumber / 2);
};

var initDeck = function(){
  // Put in orm function for theme.
  for(var i=0; i<emojiObjects.length; i++){
    themeCardsArray.push(emojiObjects[i], emojiObjects[i]);
  }
};

var difficultySelection = function(difficultyValue){
  // Select difficulty
  switch(difficultyValue) {
      case "easy":
      // 22 indicates 11 pairs of cards excluding the milo/skull special cards for this difficulty case.
          difficultyNumber = 22;
          calcWinScore(difficultyNumber);
      difficultyLevel(difficultyNumber);          
          break;
      case "medium":
      // 34 indicates 17 pairs of cards.
          difficultyNumber = 34;
          calcWinScore(difficultyNumber);
      difficultyLevel(difficultyNumber);
          break;
      case "hard":
      // 46 indicates 23 pairs of cards.
          difficultyNumber = 46;
          calcWinScore(difficultyNumber);
      difficultyLevel(difficultyNumber);          
          break;
      default:
          console.log("Difficulty not selected."); 
  }
};

var difficultyLevel = function(difficultyNumber){
  // Three difficulty levels.
  // Easy = 22 choices
  // Medium = 34 choices
  // Hard = 46 choices
  // Manipulate theme cards array and push into the actualDeck
  themeCardsArray.splice(difficultyNumber);
  console.log(themeCardsArray);
  specialCards(themeCardsArray);
};

var specialCards = function(themeCardsArray){
  // Put in orm function for skull/milo.
  for(var i=0; i<skullMilo.length; i++){
    themeCardsArray.push(skullMilo[i]);
  }

  // Before shuffle result.
  console.log(themeCardsArray);
  // Shuffling cards.
  shuffleArray(themeCardsArray);
  // After shuffle result.
  console.log(themeCardsArray); 
};

/**
 * Randomize array element order in-place.
 * Using Durstenfeld shuffle algorithm.
 */
var shuffleArray = function(array){
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    renderCards(array);
    return array;
};

var renderCards = function(array){
  for(i=0;i<themeCardsArray.length; i++){
        $(".gameboard").append("<div class='col s4 m2 l2' value='" + themeCardsArray[i].letter_id + "' id='" + (i + 1) + "'> <img src='/static/emoji/game/qm.png' class='qm' id='qm-"+ (i + 1) + '><img class= "emoji" id = "card-' + (i+1) + "src='/static/images/emojisvg/" + themeCardsArray[i].file_name + '"/>' + "</div>")
  }            
};


var evaluateFirstClick = function(reference){
    firstCardValue = reference.attr("value");
    firstCardId = reference.attr("id");
    $("#" + firstCardId).attr("disabled", 'disabled');
    console.log("First " + firstCardValue);
    firstClick = true;
};

var evaluateSecondClick = function(reference){
    console.log("Second " + firstCardValue);
    secondCardId = reference.attr("id");
    $("#" + secondCardId).attr("disabled", 'disabled');
    alert("There's a match!")
    firstCardId = "";
    firstClick = false;
    matchScore++;
    match();
};

// Increment incorrect matches then divide that number by level difficulty match. * 100.
var calcAccuracy = function(){
  console.log(((difficultyNumber / 2) / ((difficultyNumber / 2) + incorrect) * 100));
}

var match = function(){
    if(matchScore == calcWinScore(difficultyNumber)){
      calcAccuracy();
        alert("You Win!");
    }
};

var nonMatch = function(reference){
    console.log(reference.attr("value"));
    alert("Not a match!");
    $("#" + firstCardId).removeAttr("disabled");
    firstCardId = "";
    secondCardId = "";
    firstClick = false;
    incorrect++
};

var disableSpecialCard = function(reference){
    reference.attr("disabled", 'disabled');
  alert("You picked a special card " + reference.attr("value"));  
};

var resetFirstClick = function(){
  $("#" + firstCardId).removeAttr("disabled");
  firstClick = false;
};
 
$(document).on("click", '.emoji-card', function(){
  var reference = $(this); 

    if(reference.attr("disabled") !== "disabled"){
        // Milo/Skull Logic
        if(reference.attr("value") == "milo" || reference.attr("value") == "skull"){
          // Disables the milo/skull cards.
          disableSpecialCard(reference);
      
      if(reference.attr("value") == "milo"){
        // Call Andrew.
        // Reveal all cards for one second. Then flip them back.
      }else if(reference.attr("value") == "skull"){
        // Call Andrew again.
        // Cover the screen for a bit and then shuffle all cards.
        // Display a message stating all cards have been shuffled.
      }
      // Resets the first click.
      if(firstClick == true){
        resetFirstClick();
          }
        }
        // Everything else. Lol
        else if(firstClick == false){
          // First Click.
          evaluateFirstClick(reference);
        }else if(firstClick == true){
          // Evaluate second click for match.
            if(reference.attr("value") == firstCardValue){
              evaluateSecondClick(reference);
            }else{
              nonMatch(reference);
            }
        }  
    }
});

// Timer
(function() {
    var counter = 0,
        cDisplay = $(".Timer");
    format = function(t) {
        var minutes = Math.floor(t / 600),
            seconds = Math.floor((t / 10) % 60);
        minutes = (minutes < 10) ? "0" + minutes.toString() : minutes.toString();
        seconds = (seconds < 10) ? "0" + seconds.toString() : seconds.toString();
        cDisplay.text(minutes + ":" + seconds + "." + Math.floor(t % 10));
    };
    setInterval(function() {
        counter++;
        format(counter);
    }, 100);
})();



    var card1 = "NULL";
    var card2 = "NULL"

    // Flip Card
    function flipCard() {

      var cardSelected = $(this).attr('id'); 

      if (card1 == "NULL") {
        card1 = cardSelected;
      } else {
        card2 = cardSelected;
      }
      console.log("Flip Card " + cardSelected);
      var cardQM = "#qm-" + cardSelected;
      var cardImage = "#card-" + cardSelected;
      var cardDiv = "#" + cardSelected;

      $(cardDiv).attr('class', 'emoji-card nameOfThingtoFlip');

      $(cardQM).attr('class', 'qm show-card');

      $(cardDiv).css('background','radial-gradient(#f6bf00, #f4ad01)');
      setTimeout(function(){ $(cardDiv).css('background','#FFFFFF'); },500)

      $(cardImage).css('opacity','0)');
      setTimeout(function(){  $(cardImage).css('opacity','1'); },250);  
    }

    // FLIP CARD BACK BELOW HERE
    function flipCardBack(card) {

      setTimeout(function(){ 
        console.log("five seconds" + cardSelected);

        var cardQM = "#qm-" + cardSelected;
        var cardImage = "#card-" + cardSelected;
        var cardDiv = "#" + cardSelected;

        $(cardDiv).attr('class', 'emoji-card nameOfThingtoFlipBack');
       
        $(cardDiv).css('background','#FFFFFF');
        setTimeout(function(){ $(cardDiv).css('background','radial-gradient(#f6bf00, #f4ad01)') },500);

        $(cardImage).css('opacity','1)');
        setTimeout(function(){ $(cardImage).css('opacity','0'); },250)

        setTimeout(function(){ $(cardQM).attr('class', 'qm hide-card'); },250)
      }, 5000);

    }

  

    var sec = 0;

    function pad ( val ) { return val > 9 ? val : "0" + val; }
    setInterval( function(){
        document.getElementById("seconds").innerHTML=pad(++sec%60);
        document.getElementById("minutes").innerHTML=pad(parseInt(sec/60,10));
    }, 1000);

});

</script>

</body>
</html>